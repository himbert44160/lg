<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Jeu Loup-Garou ‚Äì Narration Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { background: #eee; font-family: Arial,sans-serif; margin:0; padding:0;}
    h1 { text-align: center; font-size: 2em; margin: 18px 0 12px 0; }
    .centered { display: flex; flex-direction: column; align-items: center; }
    .hidden { display: none !important; }
 .players-row, .narrateur-choix-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;  /* on commence √† gauche */
  gap: 9px;
  margin: 11px auto 11px auto;
  max-width: 99vw;
}

.player-mini, .narrateur-mini {
  display: flex;
  flex-direction: column;
  align-items: center;     /* <-- centr√© la colonne */
  flex: 0 0 calc(25% - 9px);
  max-width: calc(25% - 9px);
  width: calc(25% - 9px);
  box-sizing: border-box;
}

@media (max-width: 700px) {
  .player-mini, .narrateur-mini {
    flex: 0 0 calc(25% - 8px);
    max-width: calc(25% - 8px);
    width: calc(25% - 8px);
  }
}

    .player-avatar, .narrateur-avatar {
      width: 44px; height: 44px; border-radius: 7px; object-fit: cover;
      border: 2px solid #44d344; background: #e4e4e4; margin-bottom: 1px; box-shadow: none; transition: border .16s, filter .18s;
    }
    .player-avatar.elim { border: 2px solid #d32d2d !important; filter: grayscale(.6); opacity: 0.48;}
    .player-name, .narrateur-name {
      font-size: .94em; font-weight: bold; text-align: center; margin-bottom: 0px; color: #1a1a1a; margin-top:0;
      width:100%; word-break: break-word; line-height:1.07;
    }
    .role-view {
      font-size:.92em;font-style:italic;cursor:pointer;padding:2px 0 2px 0; text-align:center; width: 100%;
      line-height:1.11;
    }
    .role-view:hover { background:#f6f6f6bb; border-radius:4px; }
    .role-select {
      width: 92%; font-size: .99em; margin-top: 1px; margin-bottom: 2px;
      border-radius: 4px; border:1px solid #ccc; background:#fafbfc;
      text-align: center; padding: 1px 0;
      display: block; margin-left: auto; margin-right: auto;
    }
    .remove-link { color:#c00;font-size:.81em;cursor:pointer; margin-top: 2px;}
    .remove-link:hover{text-decoration:underline;}
    .narrateur-mini.selected .narrateur-avatar { border:2.5px solid #32c852; }
    .narrateur-mini.selected { background: #eafbf4; border-radius: 12px;}
    .controls { display:flex; gap:11px; justify-content:center; margin: 12px 0; }
    input[type="file"] { display: none; }
    .narration-bar {
      display: flex; flex-direction:column; align-items: center; justify-content: center;
      margin: 9px auto 11px auto; padding: 12px 3vw 15px 3vw;
      background: #fff9; border-radius: 16px; box-shadow: 0 3px 11px #0001;
      font-size: 1.08em; font-weight: 500;
      min-width: 90vw; max-width: 98vw; width: 97vw;
      color: #222; min-height:36px;
    }
    .narr-text-content {
      width: 100%; text-align: center; white-space: pre-line; margin-bottom: 20px; line-height: 1.29;
      font-size: 1.09em; word-break:break-word; overflow-wrap:break-word;
      padding-left:3px;padding-right:3px;
    }
    .narr-btn-row {
      display: flex; gap: 18px; justify-content: center; width: 100%; margin-top: 3px;
    }
    .narr-btn {
      background: #eee; border-radius: 11px; border: 1px solid #bbb;
      padding: 10px 22px; margin: 0 6px; cursor: pointer; font-size:1em;
      transition: background .12s; font-weight: 600;
      box-shadow: 0 2px 7px #0001;
    }
    .narr-btn:active { background: #c8f4ff; }
    .narr-btn:hover { background: #d6f1ff; }
    /* Boutons sons sous le texte */
    .sound-grid {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
      max-width: 97vw; margin: 10px auto 2px auto;
    }
    .sound-card {
      width: 96px; min-height: 36px; background: #fff; border-radius: 12px; box-shadow: 0 2px 7px #0001;
      padding: 11px 6px; display: flex; flex-direction: column; align-items: center; justify-content:center;
      cursor: pointer; transition: box-shadow .2s; border: 2px solid transparent;
      font-size: 1.02em; font-weight: 600; text-align:center; user-select: none;
    }
    .sound-card.active { box-shadow: 0 4px 12px #2a4; border: 2px solid #32c852; background: #f2fff5; }
    .sound-name { font-size: 1em; text-align: center; word-break: break-word; font-weight: 600; }
    @media (max-width:600px) {
      h1 { font-size: 1em; }
      .player-mini, .narrateur-mini { width: 48px; }
      .player-avatar, .narrateur-avatar { width: 34px; height:34px; }
      .narration-bar { font-size: .99em; min-width: 98vw; }
      .sound-card { width: 78px; min-height:26px; font-size:.92em;}
      .narr-btn { font-size: .96em; padding: 7px 4vw; }
    }
    .role-cupidon    { color: #00bfff; }
    .role-voyante    { color: #9c27b0; }
    .role-loups      { color: #b71c1c; }
    .role-sorciere   { color: #ff9100; }
    .role-flute      { color: #e040fb; }
    .role-joueur     { color: #00aa47; }
    .role-villageois { color: #ad8a4a;}
  </style>
</head>
<body>
  <h1>Jeu Loup-Garou <span style="font-size:0.82em;font-weight:400;">(Narration Mobile)</span></h1>
  <!-- PHASE 1 : AJOUT JOUEURS -->
  <div id="pageJoueurs" class="centered">
    <div class="players-row" id="playersAddRow"></div>
    <div class="controls">
      <input id="inpPrenom" placeholder="Pr√©nom du joueur" maxlength="16" autocomplete="off" style="width:120px;"/>
      <input type="file" accept="image/*" capture="user" id="photoFile" />
      <button id="btnAdd">‚ûï Ajouter</button>
    </div>
    <div class="controls">
      <button id="btnStartNarrateur">Valider joueurs ‚û°Ô∏è</button>
    </div>
  </div>

  <!-- PHASE 1b : CHOIX NARRATEUR -->
  <div id="pageNarrateur" class="centered hidden">
    <div style="font-size:1.12em;margin:11px 0 4px 0;">S√©lectionnez le Narrateur :</div>
    <div class="narrateur-choix-row" id="narrateurChoixRow"></div>
  </div>

  <!-- PHASE 2 : NARRATION + ROLES + VIVANTS + SONS -->
  <div id="pageSons" class="centered hidden">
    <div class="players-row" id="playersSonsRow"></div>
    <div class="narration-bar" id="narrBar">
      <div class="narr-text-content" id="narrText"></div>
      <div class="narr-btn-row">
        <button class="narr-btn" id="btnPrev">&#8592; Retour</button>
        <button class="narr-btn" id="btnNext">Suivant &#8594;</button>
        <button class="narr-btn hidden" id="btnRappeler">Oui, rappeler ce r√¥le</button>
      </div>
    </div>
    <div class="sound-grid" id="soundGrid"></div>
    <div class="controls">
      <button id="btnRejouer" style="margin-top:8px;">‚Ü©Ô∏è Recommencer</button>
    </div>
  </div>

  <script>
    const ROLES = [
      "Villageois", "Loups-Garous", "Sorci√®re", "Voyante",
      "Joueur de Fl√ªte", "Infect P√®re des loups", "Cupidon", "Ange", "Chasseur"
    ];
    const ROLE_CLASSES = {
      "Villageois":"role-villageois",
      "Cupidon":"role-cupidon",
      "Voyante":"role-voyante",
      "Loups-Garous":"role-loups",
      "Sorci√®re":"role-sorciere",
      "Joueur de Fl√ªte":"role-flute"
    };
    // Sons et bruitages (nom: affich√©, musiques: fichiers .mp3 dans dossier "son/")
    const sounds = [
      { nom: "Dague", musiques: ["son/Dague.mp3"] },
      { nom: "Election Maire", musiques: ["son/Maire.mp3"] },
      { nom: "Applaudissements", musiques: ["son/Applaudissement1.mp3","son/Applaudissement2.mp3"] },
	  { nom: "Village se r√©veille", musiques: ["son/Villagereveil1.mp3","son/Villagereveil2.mp3"] },
      { nom: "Village s'endort", musiques: ["son/Villagesendort1.mp3","son/Villagesendort2.mp3","son/Villagesendort3.mp3"] },
      { nom: "Cupidon", musiques: ["son/Cupidon.mp3"] },
      { nom: "Cupidon tire fl√®che", musiques: ["son/Cupidonfleche.mp3"] },
      { nom: "Amoureux", musiques: ["son/Amoureux1.mp3","son/Amoureux2.mp3","son/Amoureux3.mp3"] },
	  { nom: "Petite Fille", musiques: ["son/petitefille1.mp3","son/petitefille2.mp3"] },
      { nom: "Loups-Garous", musiques: ["son/Loup-Garous1.mp3","son/Loup-Garous2.mp3"] },
      { nom: "Sorci√®re", musiques: ["son/Sorciere1.mp3","son/Sorciere2.mp3","son/Sorciere3.mp3"] },
      { nom: "Voyante", musiques: ["son/Voyante.mp3"] },
      { nom: "Joueur de fl√ªte", musiques: ["son/Flute1.mp3","son/Flute2.mp3","son/Flute3.mp3"] },
      { nom: "Infect P√®re", musiques: ["son/Infectpere1.mp3","son/Infectpere2.mp3"] },
      { nom: "Pet", musiques: ["son/pet1.mp3","son/pet2.mp3","son/pet3.mp3"] },
      { nom: "Chasseur", musiques: ["son/Chasseur1.mp3","son/Chasseur2.mp3"] },
      { nom: "Ange", musiques: ["son/Ange.mp3"] },
      { nom: "Chien Loup", musiques: ["son/Chienloup1.mp3","son/Chienloup2.mp3"] },
      { nom: "Mort", musiques: ["son/mort1.mp3","son/mort2.mp3","son/mort3.mp3","son/mort4.mp3"] },
	  { nom: "Corbeau", musiques: ["son/corbeau.mp3"] }
    ];

    const STORAGE_KEY = "loupgarou_joueurs_v9";
    function savePlayers() { localStorage.setItem(STORAGE_KEY, JSON.stringify(joueurs)); }
    function loadPlayers() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch { return []; }
    }
    let joueurs = loadPlayers();
    let phase = "ajout";
    let narrateurIdx = null;
    const narration = [
      { txt: "üëÅÔ∏è‚Äçüó®Ô∏è Chaque joueur regarde discr√®tement sa carte sans la sortir de l'enveloppe.", role: null },
      { txt: "üó≥Ô∏è √âlection du Maire du village üá≤üá´\nChacun peut se pr√©senter pour √™tre √©lu üëë\nSon vote compte double et d√©partage en cas d'√©galit√©.\nEn cas d'√©limination, il d√©signe son successeur.", role: null },
      { txt: "üó°Ô∏è Balle √† piocher : La Dague !\nChaque joueur pioche une balle sans regarder (sauf le maire).\nCelui qui a la balle rouge gagne la dague üó°Ô∏è et peut doubler son vote une fois.", role: null },
      { txt: "üìú Le petit hameau de Thiercelieux est la proie d‚Äôun g√®ne mutant.\nDes Loups-Garous üê∫ se cachent parmi les Villageois üë®‚Äçüåæ.\nQue la partie commence !", role: null },
      { txt: "üåô 1√®re Nuit.\nLe village s'endort... Fermez tous les yeux üò¥ et gardez la t√™te bien droite.", role: null },
      { txt: "üíò Cupidon, r√©veille-toi !\nD√©signe deux amoureux (tu peux te d√©signer) üèπüíû", role: "Cupidon" },
      { txt: "üòå Cupidon, ferme les yeux.", role: "Cupidon" },
      { txt: "üíë Les amoureux d√©sign√©s, r√©veillez-vous et reconnaissez-vous !\nVous faites d√©sormais √©quipe ü§ù\nSi l'un meurt l'autre meurt automatiquement", role: null },
      { txt: "üò¥ Les amoureux, refermez les yeux.", role: null },
      { txt: "üîÆ Voyante, r√©veille-toi !\nTu peux regarder la carte d‚Äôun habitant üëÄ", role: "Voyante" },
      { txt: "üòå Voyante, ferme les yeux.", role: "Voyante" },
      { txt: "üê∫ Les Loups-Garous se r√©veillent et se reconnaissent !", role: "Loups-Garous" },
      { txt: "üëß Petite Fille, tu peux espionner discr√®tement...", role: "Petite Fille" },
      { txt: "üéØ Loups-Garous, d√©signez une victime (soyez d‚Äôaccord) !", role: "Loups-Garous" },
      { txt: "üò¥ Les Loups-Garous et la Petite Fille, fermez les yeux.", role: null },
      { txt: "üë®‚Äçüë¶ Infect P√®re des Loups, tu peux infecter une seule fois pendant la partie la victime (hoche la t√™te discr√®tement)\nSi c'est le cas le joueur touch√© devient Loup-Garou mais conserve ses pouvoirs de villageois ü¶†", role: "Infect P√®re des loups" },
      { txt: "üòå Infect P√®re des Loups, ferme les yeux.", role: "Infect P√®re des loups" },
      { txt: "üßô‚Äç‚ôÄÔ∏è Sorci√®re, r√©veille-toi !\nTu as 2 potions √† usage unique üß™ (soin et poison).\nUn habitant a √©t√© attaqu√©, veux-tu le sauver‚ÄØ?", role: "Sorci√®re" },
      { txt: "‚ò†Ô∏è Veux-tu utiliser ta potion d‚Äôempoisonnement‚ÄØ? Si oui, d√©signe la victime.", role: "Sorci√®re" },
      { txt: "üòå Sorci√®re, ferme les yeux.", role: "Sorci√®re" },
      { txt: "üéµ Joueur de fl√ªte, r√©veille-toi !\nCharme deux habitants de ton choix. Les joueurs touch√©s sont maintenant charm√©s par le joueur de fl√ªte üé∂", role: "Joueur de Fl√ªte" },
      { txt: "üòå Joueur de fl√ªte, ferme les yeux.", role: "Joueur de Fl√ªte" },
      { txt: "‚ú® Les joueurs charm√©s se r√©veillent, se reconnaissent et se rendorment.", role: null },
      { txt: "üåÖ Le village se r√©veille !", role: null },
      { txt: "üíÄ R√©v√©lation des victimes de la nuit (sans d√©voiler leur r√¥le).", role: null },
      { txt: "üó£Ô∏è D√©bat : chacun s‚Äôexprime une fois √† tour de r√¥le.", role: null },
      { txt: "‚úã Vote : tous l√®vent le doigt puis d√©signent la personne √† √©liminer.", role: null },
      { txt: "üö´ √âlimination : la personne ayant le plus de votes est √©limin√©e.", role: null },
	  { txt: "üêó Joueur √©limin√© √™tes vous l'ange ou le chaseur?", role: null },
      { txt: "üåô 2√®me Nuit. Le village s‚Äôendort...", role: null },
      { txt: "üîÆ Voyante, r√©veille-toi ! Tu peux regarder la carte d‚Äôun habitant.", role: "Voyante" },
      { txt: "üòå Voyante, ferme les yeux.", role: "Voyante" },
      { txt: "üê∫ Les Loups-Garous se r√©veillent. Petite Fille tu peux les espionner. D√©signez une victime.", role: "Loups-Garous" },
      { txt: "üò¥ Loups-Garous et la Petite Fille, fermez les yeux.", role: "Loups-Garous" },
	  { txt: "üë®‚Äçüë¶ Infect P√®re des Loups, veux tu infecter la victime qui rejoindra alors la horde des loups?ü¶†(hoche la t√™te discr√®tement)", role: "Infect P√®re des loups" },
      { txt: "üßô‚Äç‚ôÄÔ∏è Sorci√®re, r√©veille-toi. Veux-tu utiliser une potion‚ÄØ?", role: "Sorci√®re" },
      { txt: "üòå Sorci√®re, ferme les yeux.", role: "Sorci√®re" },
      { txt: "üåÖ Le village se r√©veille.", role: null },
	  { txt: "üíÄ R√©v√©lation des victimes de la nuit (sans d√©voiler leur r√¥le).", role: null },
      { txt: "üó£Ô∏è D√©bat : chacun s‚Äôexprime une fois √† tour de r√¥le.", role: null },
      { txt: "‚úã Vote : tous l√®vent le doigt puis d√©signent la personne √† √©liminer.", role: null },
      { txt: "üö´ √âlimination : la personne ayant le plus de votes est √©limin√©e.", role: null },
	  { txt: "üêó Joueur √©limin√© √™tes vous le chaseur?", role: null },
	  { txt: "üåô 3√®me Nuit. Le village s‚Äôendort...", role: null },
      { txt: "üîÆ Voyante, r√©veille-toi ! Tu peux regarder la carte d‚Äôun habitant.", role: "Voyante" },
      { txt: "üòå Voyante, ferme les yeux.", role: "Voyante" },
      { txt: "üê∫ Les Loups-Garous se r√©veillent. Petite Fille tu peux les espionner. D√©signez une victime.", role: "Loups-Garous" },
      { txt: "üò¥ Loups-Garous et la Petite Fille, fermez les yeux.", role: "Loups-Garous" },
	  { txt: "üë®‚Äçüë¶ Infect P√®re des Loups, veux tu infecter la victime qui rejoindra alors la horde des loups?ü¶†(hoche la t√™te discr√®tement)", role: "Infect P√®re des loups" },
      { txt: "üßô‚Äç‚ôÄÔ∏è Sorci√®re, r√©veille-toi. Veux-tu utiliser une potion‚ÄØ?", role: "Sorci√®re" },
      { txt: "üòå Sorci√®re, ferme les yeux.", role: "Sorci√®re" },
      { txt: "üåÖ Le village se r√©veille.", role: null },
	  { txt: "üíÄ R√©v√©lation des victimes de la nuit (sans d√©voiler leur r√¥le).", role: null },
      { txt: "üó£Ô∏è D√©bat : chacun s‚Äôexprime une fois √† tour de r√¥le.", role: null },
      { txt: "‚úã Vote : tous l√®vent le doigt puis d√©signent la personne √† √©liminer.", role: null },
      { txt: "üö´ √âlimination : la personne ayant le plus de votes est √©limin√©e.", role: null },
	  { txt: "üêó Joueur √©limin√© √™tes vous le chaseur?", role: null },
	  { txt: "üåô 4√®me Nuit. Le village s‚Äôendort...", role: null },
      { txt: "üîÆ Voyante, r√©veille-toi ! Tu peux regarder la carte d‚Äôun habitant.", role: "Voyante" },
      { txt: "üòå Voyante, ferme les yeux.", role: "Voyante" },
      { txt: "üê∫ Les Loups-Garous se r√©veillent. Petite Fille tu peux les espionner. D√©signez une victime.", role: "Loups-Garous" },
      { txt: "üò¥ Loups-Garous et la Petite Fille, fermez les yeux.", role: "Loups-Garous" },
	  { txt: "üë®‚Äçüë¶ Infect P√®re des Loups, veux tu infecter la victime qui rejoindra alors la horde des loups?ü¶†(hoche la t√™te discr√®tement)", role: "Infect P√®re des loups" },
      { txt: "üßô‚Äç‚ôÄÔ∏è Sorci√®re, r√©veille-toi. Veux-tu utiliser une potion‚ÄØ?", role: "Sorci√®re" },
      { txt: "üòå Sorci√®re, ferme les yeux.", role: "Sorci√®re" },
      { txt: "üåÖ Le village se r√©veille.", role: null },
	  { txt: "üíÄ R√©v√©lation des victimes de la nuit (sans d√©voiler leur r√¥le).", role: null },
      { txt: "üó£Ô∏è D√©bat : chacun s‚Äôexprime une fois √† tour de r√¥le.", role: null },
      { txt: "‚úã Vote : tous l√®vent le doigt puis d√©signent la personne √† √©liminer.", role: null },
      { txt: "üö´ √âlimination : la personne ayant le plus de votes est √©limin√©e.", role: null },
	  { txt: "üêó Joueur √©limin√© √™tes vous le chaseur?", role: null },
	  { txt: "üåô 5√®me Nuit. Le village s‚Äôendort...", role: null },
      { txt: "üîÆ Voyante, r√©veille-toi ! Tu peux regarder la carte d‚Äôun habitant.", role: "Voyante" },
      { txt: "üòå Voyante, ferme les yeux.", role: "Voyante" },
      { txt: "üê∫ Les Loups-Garous se r√©veillent. Petite Fille tu peux les espionner. D√©signez une victime.", role: "Loups-Garous" },
      { txt: "üò¥ Loups-Garous et la Petite Fille, fermez les yeux.", role: "Loups-Garous" },
	  { txt: "üë®‚Äçüë¶ Infect P√®re des Loups, veux tu infecter la victime qui rejoindra alors la horde des loups?ü¶†(hoche la t√™te discr√®tement)", role: "Infect P√®re des loups" },
      { txt: "üßô‚Äç‚ôÄÔ∏è Sorci√®re, r√©veille-toi. Veux-tu utiliser une potion‚ÄØ?", role: "Sorci√®re" },
      { txt: "üòå Sorci√®re, ferme les yeux.", role: "Sorci√®re" },
      { txt: "üåÖ Le village se r√©veille.", role: null },
	  { txt: "üíÄ R√©v√©lation des victimes de la nuit (sans d√©voiler leur r√¥le).", role: null },
      { txt: "üó£Ô∏è D√©bat : chacun s‚Äôexprime une fois √† tour de r√¥le.", role: null },
      { txt: "‚úã Vote : tous l√®vent le doigt puis d√©signent la personne √† √©liminer.", role: null },
      { txt: "üö´ √âlimination : la personne ayant le plus de votes est √©limin√©e.", role: null },
	  { txt: "üêó Joueur √©limin√© √™tes vous le chaseur?", role: null },
	  { txt: "üåô 6√®me Nuit. Le village s‚Äôendort...", role: null },
      { txt: "üîÆ Voyante, r√©veille-toi ! Tu peux regarder la carte d‚Äôun habitant.", role: "Voyante" },
      { txt: "üòå Voyante, ferme les yeux.", role: "Voyante" },
      { txt: "üê∫ Les Loups-Garous se r√©veillent. Petite Fille tu peux les espionner. D√©signez une victime.", role: "Loups-Garous" },
      { txt: "üò¥ Loups-Garous et la Petite Fille, fermez les yeux.", role: "Loups-Garous" },
	  { txt: "üë®‚Äçüë¶ Infect P√®re des Loups, veux tu infecter la victime qui rejoindra alors la horde des loups?ü¶†(hoche la t√™te discr√®tement)", role: "Infect P√®re des loups" },
      { txt: "üßô‚Äç‚ôÄÔ∏è Sorci√®re, r√©veille-toi. Veux-tu utiliser une potion‚ÄØ?", role: "Sorci√®re" },
      { txt: "üòå Sorci√®re, ferme les yeux.", role: "Sorci√®re" },
      { txt: "üåÖ Le village se r√©veille.", role: null },
	  { txt: "üíÄ R√©v√©lation des victimes de la nuit (sans d√©voiler leur r√¥le).", role: null },
      { txt: "üó£Ô∏è D√©bat : chacun s‚Äôexprime une fois √† tour de r√¥le.", role: null },
      { txt: "‚úã Vote : tous l√®vent le doigt puis d√©signent la personne √† √©liminer.", role: null },
      { txt: "üö´ √âlimination : la personne ayant le plus de votes est √©limin√©e.", role: null },
	  { txt: "üêó Joueur √©limin√© √™tes vous le chaseur?", role: null },
	  { txt: "üåô 7√®me Nuit. Le village s‚Äôendort...", role: null },
      { txt: "üîÆ Voyante, r√©veille-toi ! Tu peux regarder la carte d‚Äôun habitant.", role: "Voyante" },
      { txt: "üòå Voyante, ferme les yeux.", role: "Voyante" },
      { txt: "üê∫ Les Loups-Garous se r√©veillent. Petite Fille tu peux les espionner. D√©signez une victime.", role: "Loups-Garous" },
      { txt: "üò¥ Loups-Garous et la Petite Fille, fermez les yeux.", role: "Loups-Garous" },
	  { txt: "üë®‚Äçüë¶ Infect P√®re des Loups, veux tu infecter la victime qui rejoindra alors la horde des loups?ü¶†(hoche la t√™te discr√®tement)", role: "Infect P√®re des loups" },
      { txt: "üßô‚Äç‚ôÄÔ∏è Sorci√®re, r√©veille-toi. Veux-tu utiliser une potion‚ÄØ?", role: "Sorci√®re" },
      { txt: "üòå Sorci√®re, ferme les yeux.", role: "Sorci√®re" },
      { txt: "üåÖ Le village se r√©veille.", role: null },
	  { txt: "üíÄ R√©v√©lation des victimes de la nuit (sans d√©voiler leur r√¥le).", role: null },
      { txt: "üó£Ô∏è D√©bat : chacun s‚Äôexprime une fois √† tour de r√¥le.", role: null },
      { txt: "‚úã Vote : tous l√®vent le doigt puis d√©signent la personne √† √©liminer.", role: null },
      { txt: "üö´ √âlimination : la personne ayant le plus de votes est √©limin√©e.", role: null },
	  { txt: "üêó Joueur √©limin√© √™tes vous le chaseur?", role: null },
	  { txt: "üåô 8√®me Nuit. Le village s‚Äôendort...", role: null },
      { txt: "üîÆ Voyante, r√©veille-toi ! Tu peux regarder la carte d‚Äôun habitant.", role: "Voyante" },
      { txt: "üòå Voyante, ferme les yeux.", role: "Voyante" },
      { txt: "üê∫ Les Loups-Garous se r√©veillent. Petite Fille tu peux les espionner. D√©signez une victime.", role: "Loups-Garous" },
      { txt: "üò¥ Loups-Garous et la Petite Fille, fermez les yeux.", role: "Loups-Garous" },
	  { txt: "üë®‚Äçüë¶ Infect P√®re des Loups, veux tu infecter la victime qui rejoindra alors la horde des loups?ü¶†(hoche la t√™te discr√®tement)", role: "Infect P√®re des loups" },
      { txt: "üßô‚Äç‚ôÄÔ∏è Sorci√®re, r√©veille-toi. Veux-tu utiliser une potion‚ÄØ?", role: "Sorci√®re" },
      { txt: "üòå Sorci√®re, ferme les yeux.", role: "Sorci√®re" },
      { txt: "üåÖ Le village se r√©veille.", role: null },
	  { txt: "üíÄ R√©v√©lation des victimes de la nuit (sans d√©voiler leur r√¥le).", role: null },
      { txt: "üó£Ô∏è D√©bat : chacun s‚Äôexprime une fois √† tour de r√¥le.", role: null },
      { txt: "‚úã Vote : tous l√®vent le doigt puis d√©signent la personne √† √©liminer.", role: null },
      { txt: "üö´ √âlimination : la personne ayant le plus de votes est √©limin√©e.", role: null },
	  { txt: "üêó Joueur √©limin√© √™tes vous le chaseur?", role: null },
	  { txt: "üåô 9√®me Nuit. Le village s‚Äôendort...", role: null },
      { txt: "üîÆ Voyante, r√©veille-toi ! Tu peux regarder la carte d‚Äôun habitant.", role: "Voyante" },
      { txt: "üòå Voyante, ferme les yeux.", role: "Voyante" },
      { txt: "üê∫ Les Loups-Garous se r√©veillent. Petite Fille tu peux les espionner. D√©signez une victime.", role: "Loups-Garous" },
      { txt: "üò¥ Loups-Garous et la Petite Fille, fermez les yeux.", role: "Loups-Garous" },
	  { txt: "üë®‚Äçüë¶ Infect P√®re des Loups, veux tu infecter la victime qui rejoindra alors la horde des loups?ü¶†(hoche la t√™te discr√®tement)", role: "Infect P√®re des loups" },
      { txt: "üßô‚Äç‚ôÄÔ∏è Sorci√®re, r√©veille-toi. Veux-tu utiliser une potion‚ÄØ?", role: "Sorci√®re" },
      { txt: "üòå Sorci√®re, ferme les yeux.", role: "Sorci√®re" },
      { txt: "üåÖ Le village se r√©veille.", role: null },
	  { txt: "üíÄ R√©v√©lation des victimes de la nuit (sans d√©voiler leur r√¥le).", role: null },
      { txt: "üó£Ô∏è D√©bat : chacun s‚Äôexprime une fois √† tour de r√¥le.", role: null },
      { txt: "‚úã Vote : tous l√®vent le doigt puis d√©signent la personne √† √©liminer.", role: null },
      { txt: "üö´ √âlimination : la personne ayant le plus de votes est √©limin√©e.", role: null },
	  { txt: "üêó Joueur √©limin√© √™tes vous le chaseur?", role: null }
    ];
    let narrIdx = 0;

    // PHASE AJOUT JOUEURS
    function renderAjoutJoueurs() {
      document.getElementById('pageJoueurs').classList.remove('hidden');
      document.getElementById('pageNarrateur').classList.add('hidden');
      const row = document.getElementById('playersAddRow');
      row.innerHTML = joueurs.map((j,i) => `
        <div class="player-mini" data-nom="${j.nom}">
          <img src="${j.photo ? j.photo : 'https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png'}" class="player-avatar" />
          <div class="player-name">${j.nom}</div>
          <div class="remove-link" data-suppr="${j.nom}">Supprimer</div>
        </div>
      `).join('');
      row.querySelectorAll(".player-avatar").forEach((img,idx) => {
        img.onclick = function() {
          document.getElementById('photoFile').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
              joueurs[idx].photo = ev.target.result;
              savePlayers();
              renderAjoutJoueurs();
            };
            reader.readAsDataURL(file);
          };
          document.getElementById('photoFile').click();
        }
      });
      row.querySelectorAll(".remove-link").forEach(link => {
        link.onclick = function() {
          const nom = link.getAttribute("data-suppr");
          joueurs = joueurs.filter(j => j.nom !== nom);
          savePlayers();
          renderAjoutJoueurs();
        }
      });
    }
    document.getElementById('btnAdd').onclick = addPlayer;
    document.getElementById('inpPrenom').addEventListener('keydown', e => { if (e.key === 'Enter') addPlayer(); });
    function addPlayer() {
      const n = document.getElementById('inpPrenom').value.trim();
      if (!n || joueurs.find(j => j.nom === n)) return;
      joueurs.push({ nom: n, photo: null, role: "Villageois", vivant: true });
      document.getElementById('inpPrenom').value = '';
      savePlayers();
      renderAjoutJoueurs();
    }
    document.getElementById('btnStartNarrateur').onclick = () => {
      if (joueurs.length < 3) return alert('Au moins 3 joueurs requis');
      phase = "narrateur";
      renderNarrateurChoix();
    };

    // PHASE CHOIX NARRATEUR
    function renderNarrateurChoix() {
      document.getElementById('pageJoueurs').classList.add('hidden');
      document.getElementById('pageNarrateur').classList.remove('hidden');
      const row = document.getElementById('narrateurChoixRow');
      row.innerHTML = joueurs.map((j,i) =>
        `<div class="narrateur-mini${narrateurIdx===i?' selected':''}" data-idx="${i}">
           <img src="${j.photo ? j.photo : 'https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png'}" class="narrateur-avatar"/>
           <div class="narrateur-name">${j.nom}</div>
         </div>`
      ).join('');
      row.querySelectorAll(".narrateur-mini").forEach(card => {
        card.onclick = function() {
          narrateurIdx = Number(card.getAttribute('data-idx'));
          phase = "sons";
          joueurs.forEach(j => { j.vivant = true; if (!j.role) j.role = "Villageois"; });
          savePlayers();
          render();
        };
      });
    }

    // PAGE SONS (Joueurs affich√©s + r√¥les √©ditables + morts)
    function renderSonsJoueurs() {
      const row = document.getElementById('playersSonsRow');
      row.innerHTML = joueurs.map((j,idx) =>
        (idx!==narrateurIdx ? `
        <div class="player-mini">
          <img src="${j.photo ? j.photo : 'https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png'}"
               class="player-avatar${j.vivant ? '' : ' elim'}"
               style="border:2px solid ${j.vivant ? '#44d344' : '#d32d2d'}"
               data-idx="${idx}" />
          <div class="player-name">${j.nom}</div>
          <div class="role-view ${ROLE_CLASSES[j.role]||''}" data-idx="${idx}">
            ${formatRoleText(j.role)}
          </div>
          <select class="role-select hidden" data-idx="${idx}">
            ${ROLES.map(r=>`<option value="${r}" ${j.role===r?'selected':''}>${r}</option>`).join('')}
          </select>
        </div>
        ` : '')
      ).join('');
      row.querySelectorAll(".player-avatar").forEach(img => {
        img.onclick = function() {
          const idx = Number(img.getAttribute('data-idx'));
          joueurs[idx].vivant = !joueurs[idx].vivant;
          savePlayers();
          renderSonsJoueurs();
        }
      });
      row.querySelectorAll(".role-view").forEach(div => {
        div.onclick = function(e) {
          const idx = Number(div.getAttribute('data-idx'));
          row.querySelectorAll(".role-select").forEach(sel=>sel.classList.add('hidden'));
          row.querySelectorAll(".role-view").forEach(rv=>rv.style.display="");
          div.style.display="none";
          const sel = row.querySelector(`.role-select[data-idx="${idx}"]`);
          sel.classList.remove('hidden');
          sel.focus();
          setTimeout(() => { sel.size=ROLES.length; }, 0);
        }
      });
      row.querySelectorAll(".role-select").forEach(sel => {
        sel.onchange = function() {
          const idx = Number(sel.getAttribute('data-idx'));
          joueurs[idx].role = sel.value;
          savePlayers();
          renderSonsJoueurs();
        };
        sel.onblur = function() { renderSonsJoueurs(); }
      });
    }
    function formatRoleText(role) {
      if (role === "Joueur de Fl√ªte") return "Joueur de<br>Fl√ªte";
      if (role === "Loups-Garous") return "Loups-<br>Garous";
      if (role === "Infect P√®re des loups") return "Infect P√®re<br>des loups";
      if (role === "Petite Fille") return "Petite<br>Fille";
      if (role === "Villageois") return "Villageois";
      if (role === "Sorci√®re") return "Sorci√®re";
      if (role === "Voyante") return "Voyante";
      if (role === "Cupidon") return "Cupidon";
      if (role === "Chasseur") return "Chasseur";
      if (role === "Ange") return "Ange";
      return role;
    }

    document.getElementById('btnRejouer').onclick = () => {
      joueurs.forEach(j => { j.vivant=true; j.role="Villageois"; });
      savePlayers();
      phase = "ajout";
      narrateurIdx = null;
      render();
    };

    // Sons (rectangles textes seuls)
    let audioObjs = [];
function renderSons() {
  const grid = document.getElementById('soundGrid');
  grid.innerHTML = "";
  audioObjs = [];
  sounds.forEach((s, idx) => {
    const audios = s.musiques.map(src => {
      const audio = document.createElement('audio');
      audio.src = src;
      audio.preload = "auto";
      document.body.appendChild(audio);
      return audio;
    });
    audioObjs.push(...audios);
    s.playIdx = 0;
    s.state = 'stopped';

    // Ajout de l'emoji √† gauche du nom
    function getSoundEmoji(nom) {
      nom = nom.toLowerCase();
      if (nom.includes("dague")) return "üó°Ô∏è";
      if (nom.includes("maire")) return "üá≤üá´";
      if (nom.includes("applaud")) return "üëè";
      if (nom.includes("village s'endort")) return "üåô";
      if (nom.includes("cupidon")) return "üíò";
      if (nom.includes("fl√®che")) return "üèπ";
      if (nom.includes("amoureux")) return "üíë";
      if (nom.includes("loups")) return "üê∫";
      if (nom.includes("sorci√®re")) return "üßô‚Äç‚ôÄÔ∏è";
      if (nom.includes("voyante")) return "üîÆ";
      if (nom.includes("joueur de fl√ªte")) return "üéµ";
      if (nom.includes("infect")) return "ü¶†";
      if (nom.includes("r√©veille")) return "üåÖ";
      if (nom.includes("pet")) return "üí®";
      if (nom.includes("chasseur")) return "üéØ";
      if (nom.includes("ange")) return "üòá";
      if (nom.includes("chien loup")) return "üêï";
      if (nom.includes("mort")) return "üíÄ";
      return "üé∂";
    }
    const card = document.createElement('div');
    card.className = "sound-card";
    card.innerHTML = `<div class="sound-name">${getSoundEmoji(s.nom)} ${s.nom}</div>`;
    card.onclick = function() {
      stopAllSoundsExcept(audios);
      if (s.state === 'stopped') {
        audios[s.playIdx].currentTime = 0;
        audios[s.playIdx].play();
        card.classList.add('active');
        s.state = 'playing';
      } else {
        audios[s.playIdx].pause();
        audios[s.playIdx].currentTime = 0;
        card.classList.remove('active');
        s.state = 'stopped';
        s.playIdx = (s.playIdx + 1) % audios.length;
      }
    };
    audios.forEach(audio => {
      audio.onended = () => {
        s.state = 'stopped';
        card.classList.remove('active');
      }
    });
    grid.appendChild(card);
  });
}

    function stopAllSoundsExcept(allowedAudios=[]) {
      audioObjs.forEach(audio => {
        if (!allowedAudios.includes(audio)) {
          audio.pause();
          audio.currentTime = 0;
        }
      });
      document.querySelectorAll('.sound-card').forEach(el => el.classList.remove('active'));
    }

    function narrCanBeShown(idx) {
      if (!narration[idx].role) return true;
      return joueurs.some((j,i) => j.role === narration[idx].role && j.vivant && i !== narrateurIdx);
    }
    function renderNarration() {
      const narrText = document.getElementById("narrText");
      const btnPrev = document.getElementById("btnPrev");
      const btnNext = document.getElementById("btnNext");
      const btnRappeler = document.getElementById("btnRappeler");
      let curIdx = narrIdx;
      let mort = false;
      if (narration[curIdx].role) {
        const vivants = joueurs.filter((j,i) => j.role === narration[curIdx].role && j.vivant && i !== narrateurIdx);
        mort = vivants.length === 0;
      }
      if (mort) {
        narrText.innerHTML = `<span style="color:#c00">${narration[curIdx].txt.replace(/\n/g,"<br>")}</span>`;
        btnNext.classList.remove('hidden');
        btnRappeler.classList.add('hidden');
      } else {
        narrText.innerHTML = narration[curIdx].txt.replace(/\n/g,"<br>");
        btnNext.classList.remove('hidden');
        btnRappeler.classList.add('hidden');
      }
      btnPrev.disabled = (curIdx===0);
      btnNext.disabled = false;
      btnPrev.onclick = function() {
        narrIdx = Math.max(0, narrIdx-1);
        renderNarration();
      }
      btnNext.onclick = function() {
        let next = narrIdx+1;
        if (next >= narration.length) narrIdx = 0;
        else narrIdx = next;
        renderNarration();
      }
    }

    function render() {
      document.getElementById("pageJoueurs").classList.toggle("hidden", phase!=="ajout");
      document.getElementById("pageNarrateur").classList.toggle("hidden", phase!=="narrateur");
      document.getElementById("pageSons").classList.toggle("hidden", phase!=="sons");
      if (phase==="ajout") renderAjoutJoueurs();
      if (phase==="narrateur") renderNarrateurChoix();
      if (phase==="sons") {
        renderSonsJoueurs();
        renderNarration();
        renderSons();
      }
    }
    render();
  </script>
</body>
</html>
